<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>3D æ™‚é˜å±•ç¤ºï¼ˆäº®æš—æ¨¡å¼åˆ‡æ›ï¼‰</title>
  <style>
    body { margin: 0; }
    canvas { display: block; }
  </style>
  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.152.2/build/three.module.js"
    }
  }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/dat.gui@0.7.9/build/dat.gui.min.js"></script>
</head>
<body>
  <script type="module">
    import * as THREE from 'three';
    import { GLTFLoader } from 'https://unpkg.com/three@0.152.2/examples/jsm/loaders/GLTFLoader.js';
    import { OrbitControls } from 'https://unpkg.com/three@0.152.2/examples/jsm/controls/OrbitControls.js';

    let scene, camera, renderer, clockModel;
    let hourHand, minuteHand, secondHand;
    let controls, ambientLight, pointLight;

    // åˆå§‹è¨­å®šï¼ˆåŒ…å«æè³ªèˆ‡å…‰æºï¼‰
    const defaultSettings = {
      envIntensity: 0.4,           // ç’°å¢ƒè²¼åœ–åå°„å¼·åº¦
      metalness: 0.36,              // æè³ªé‡‘å±¬åº¦
      roughness: 1,              // æè³ªç²—ç³™åº¦
      ambientIntensity: 2,       // ç’°å¢ƒå…‰å¼·åº¦
      pointIntensity: 1.5,         // é»å…‰æºå¼·åº¦
      ambientColor: "#ffffff"      // ç’°å¢ƒå…‰é¡è‰²ï¼ˆå¯èª¿æ•´ï¼‰
    };

    // è¤‡è£½è¨­å®š
    const settings = { ...defaultSettings };

    init();
    animate();

    function init(){
      scene = new THREE.Scene();

      // åˆ¤æ–·è¢å¹•æ¯”ä¾‹ä»¥åˆ‡æ›èƒŒæ™¯å½±ç‰‡
      const aspectRatio = window.innerWidth / window.innerHeight;
      const videoURL = (aspectRatio >= 16/9)
        ? "https://changyungfu.github.io/3D_Model/bg_16_9.mp4"
        : "https://changyungfu.github.io/3D_Model/bg_9_16.mp4";

      // å»ºç«‹èƒŒæ™¯å½±ç‰‡ç´‹ç†
      const video = document.createElement('video'); // å»ºç«‹ <video> å…ƒç´ 
      video.src = videoURL;
      video.crossOrigin = 'anonymous';
      video.loop = true;
      video.muted = true;
      video.playsInline = true;
      video.play();

      const videoTexture = new THREE.VideoTexture(video);
      videoTexture.format = THREE.RGBAFormat;
      videoTexture.minFilter = THREE.LinearFilter;
      videoTexture.magFilter = THREE.LinearFilter;
      scene.background = videoTexture;

      // è¼‰å…¥ç’°å¢ƒè²¼åœ–ï¼ˆç”¨æ–¼ PBR åå°„ï¼‰
      const cubeTextureLoader = new THREE.CubeTextureLoader();
      const envMap = cubeTextureLoader.load([
        'https://threejs.org/examples/textures/cube/Park2/posx.jpg',
        'https://threejs.org/examples/textures/cube/Park2/negx.jpg',
        'https://threejs.org/examples/textures/cube/Park2/posy.jpg',
        'https://threejs.org/examples/textures/cube/Park2/negy.jpg',
        'https://threejs.org/examples/textures/cube/Park2/posz.jpg',
        'https://threejs.org/examples/textures/cube/Park2/negz.jpg'
      ]);
      scene.environment = envMap;

      // å»ºç«‹ç›¸æ©Ÿèˆ‡æ¸²æŸ“å™¨
      camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 10000);
      camera.position.set(0, 50, 100);
      camera.lookAt(0, 0, 0);

      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.outputColorSpace = THREE.SRGBColorSpace;
      renderer.toneMapping = THREE.ACESFilmicToneMapping;
      renderer.useLegacyLights = false;
      document.body.appendChild(renderer.domElement);

      // åŠ å…¥ OrbitControls æ§åˆ¶å™¨
      controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;

      // åŠ å…¥ç’°å¢ƒå…‰èˆ‡é»å…‰æº
      ambientLight = new THREE.AmbientLight(settings.ambientColor, settings.ambientIntensity);
      pointLight = new THREE.PointLight(0xffffff, settings.pointIntensity, 1000);
      pointLight.position.set(100, 100, 200);
      scene.add(ambientLight, pointLight);

      // è¼‰å…¥ 3D æ™‚é˜æ¨¡å‹
      const loader = new GLTFLoader();
      const modelURL = 'https://changyungfu.github.io/3D_Model/2Dè²¼åœ–_3Dæ¸…æ™°å¯è¦‹çš„æ™‚é˜é¢æ¿_ç°¡æ½”çš„æŒ‡é‡V1.glb';

      loader.load(modelURL, gltf => {
        clockModel = gltf.scene;
        clockModel.scale.set(0.2, 0.2, 0.2); // ç”± cm ç¸®å°ç‚º m
        scene.add(clockModel);

        // ç½®ä¸­æ¨¡å‹ä¸¦èª¿æ•´ç›¸æ©Ÿè·é›¢ä»¥è‡ªå‹•é©é…
        const box = new THREE.Box3().setFromObject(clockModel);
        const center = new THREE.Vector3();
        box.getCenter(center);
        clockModel.position.sub(center);

        const size = new THREE.Vector3();
        box.getSize(size);
        const maxDim = Math.max(size.x, size.y, size.z);
        const fov = camera.fov * (Math.PI / 180);
        const cameraZ = Math.abs(maxDim / 2 / Math.tan(fov / 2));
        camera.position.set(0, 0, cameraZ );
        camera.lookAt(0, 0, 0);
        controls.update();

        updateMaterialProperties(); // å¥—ç”¨åˆå§‹æè³ªè¨­å®š

        // å–å¾—æŒ‡é‡ç¯€é»åç¨±ï¼ˆéœ€èˆ‡æ¨¡å‹å…§éƒ¨ä¸€è‡´ï¼‰
        hourHand = clockModel.getObjectByName('hour');
        minuteHand = clockModel.getObjectByName('minute');
        secondHand = clockModel.getObjectByName('second');
      });

      // è¦–çª—å°ºå¯¸æ”¹è®Šæ™‚æ›´æ–°æ”å½±æ©Ÿèˆ‡æ¸²æŸ“å™¨
      window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });

      setupGUI(); // å»ºç«‹ GUI æ§åˆ¶é¢æ¿
    }

    function animate(){
      requestAnimationFrame(animate);
      updateClock(); // æ›´æ–°æŒ‡é‡
      controls.update();
      renderer.render(scene, camera);
    }

    // æ ¹æ“šç•¶å‰æ™‚é–“æ›´æ–°æŒ‡é‡æ—‹è½‰è§’åº¦
    function updateClock(){
      if(!clockModel) return;
      const now = new Date();
      const hours = now.getHours() % 12;
      const minutes = now.getMinutes();
      const seconds = now.getSeconds();
      const hourAngle = (hours + minutes / 60) * (Math.PI / 6);
      const minuteAngle = (minutes + seconds / 60) * (Math.PI / 30);
      const secondAngle = seconds * (Math.PI / 30);
      if(hourHand) hourHand.rotation.z = -hourAngle;
      if(minuteHand) minuteHand.rotation.z = -minuteAngle;
      if(secondHand) secondHand.rotation.z = -secondAngle;
    }

    // è¨­å®šæ§åˆ¶é¢æ¿ï¼ˆdat.GUIï¼‰
    function setupGUI(){
      const gui = new dat.GUI();
      gui.add(settings, 'envIntensity', 0, 5).step(0.1).name('åå°„å¼·åº¦').onChange(updateMaterialProperties);
      gui.add(settings, 'metalness', 0, 1).step(0.01).name('é‡‘å±¬åº¦').onChange(updateMaterialProperties);
      gui.add(settings, 'roughness', 0, 1).step(0.01).name('ç²—ç³™åº¦').onChange(updateMaterialProperties);
      gui.add(settings, 'ambientIntensity', 0, 5).step(0.1).name('ç’°å¢ƒå…‰å¼·åº¦').onChange(val => {
        settings.ambientIntensity = val;
        ambientLight.intensity = val;
      });
      gui.addColor(settings, 'ambientColor').name('ç’°å¢ƒå…‰é¡è‰²').onChange(val => {
        ambientLight.color.set(val);
      });
      gui.add(settings, 'pointIntensity', 0, 5).step(0.1).name('é»å…‰æº').onChange(val => {
        settings.pointIntensity = val;
        pointLight.intensity = val;
      });
      gui.add({ reset: () => resetSettings() }, 'reset').name('ğŸ”„ é‡è¨­åƒæ•¸'); // åŠ å…¥ä¸€éµé‡è¨­åŠŸèƒ½

      // åŠ å…¥é»å…‰æºä½ç½®æ§åˆ¶æ»‘æ¡¿
      const lightFolder = gui.addFolder('é»å…‰æºä½ç½®');
      lightFolder.add(pointLight.position, 'x', -500, 500).step(1).name('X ä½ç½®');
      lightFolder.add(pointLight.position, 'y', -500, 500).step(1).name('Y ä½ç½®');
      lightFolder.add(pointLight.position, 'z', -2500, 2500).step(1).name('Z ä½ç½®'); // åŠ å…¥ä¸€éµé‡è¨­åŠŸèƒ½
      //gui.domElement.style.display = 'none';
    }

    // å¥—ç”¨æè³ªè¨­å®šåˆ°æ¨¡å‹ä¸Š
    function updateMaterialProperties(){
      if(!clockModel) return;
      clockModel.traverse(child => {
        if(child.isMesh && child.material){
          const materials = Array.isArray(child.material) ? child.material : [child.material];
          materials.forEach(mat => {
            mat.metalness = settings.metalness;
            mat.roughness = settings.roughness;
            mat.envMapIntensity = settings.envIntensity;
            mat.needsUpdate = true;
          });
        }
      });
    }

    // é‡è¨­æ»‘æ¡¿èˆ‡æè³ªç‚ºé è¨­å€¼
    function resetSettings(){
      Object.assign(settings, defaultSettings);
      ambientLight.intensity = settings.ambientIntensity;
      ambientLight.color.set(settings.ambientColor);
      pointLight.intensity = settings.pointIntensity;
      updateMaterialProperties();
    }
  </script>
</body>
</html>
